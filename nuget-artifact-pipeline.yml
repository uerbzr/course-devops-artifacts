# Starter pipeline
# Minimal setup: build, test, pack, and push NuGet package based on .csproj-defined version

name: "1.0.$(Rev:r)" # pipeline build name using revision for uniqueness

trigger:
  - main

pool:
  vmImage: ubuntu-latest

jobs:
  - job: BuildAndTest
    displayName: Build and Test
    steps:
      - task: UseDotNet@2
        displayName: "Install .NET 9 SDK"
        inputs:
          packageType: "sdk"
          version: "9.0.x"
          includePreviewVersions: true

      - task: DotNetCoreCLI@2
        displayName: dotnet restore
        inputs:
          command: "restore"
          projects: "**/workshop.calculator.csproj"
          feedsToUse: "select"
          vstsFeed: "09a3d620-34df-4061-a07f-7f7f531020df"

      - task: DotNetCoreCLI@2
        displayName: dotnet build
        inputs:
          command: "build"
          projects: "**/workshop.calculator.csproj"

      - task: DotNetCoreCLI@2
        displayName: dotnet test
        inputs:
          command: "test"
          projects: "**/workshop.tests.csproj"

  - job: CreateNugetPackage
    displayName: Create NuGet Package
    dependsOn: BuildAndTest
    condition: succeeded()
    steps:
      - task: UseDotNet@2
        displayName: "Install .NET 9 SDK"
        inputs:
          packageType: "sdk"
          version: "9.0.x"
          includePreviewVersions: true

      - task: NuGetAuthenticate@1
        displayName: "Authenticate to Azure Artifacts"

      - task: DotNetCoreCLI@2
        displayName: "Pack NuGet Package (using version from .csproj)"
        inputs:
          command: "pack"
          packagesToPack: "**/workshop.calculator.csproj"
          versioningScheme: "off"
          includesNuGetOrg: true
          arguments: "--configuration Release"
          outputDir: "$(Build.ArtifactStagingDirectory)"

      - task: CmdLine@2
        displayName: "List .nupkg files"
        inputs:
          script: |
            echo "Listing .nupkg files:"
            find "$(Build.ArtifactStagingDirectory)" -name "*.nupkg"

      - task: DotNetCoreCLI@2
        displayName: "Push NuGet Package (using wildcard)"
        inputs:
          command: "push"
          packagesToPush: "$(Build.ArtifactStagingDirectory)/**/*.nupkg"
          nuGetFeedType: "internal"
          publishVstsFeed: "9c1bc6ac-5cb4-4149-9cad-a096551fb621"
          publishFeedCredentials: "calculatorserviceserviceconnection"

      - task: PublishBuildArtifacts@1
        displayName: Publish pipeline artifacts
        inputs:
          PathtoPublish: "$(Build.ArtifactStagingDirectory)"
          TargetPath: '\\calculator\$(Build.DefinitionName)\$(Build.BuildNumber)'
          ArtifactName: "drop"
          publishLocation: "Container"
